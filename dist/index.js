import e from"cache-manager";import t from"cache-manager-ioredis";import a from"parse5";import{get as o,filter as n}from"lodash";import i from"http";import r from"https";import{imageSize as s}from"image-size";import{parse as c}from"url";import d from"lodash/merge";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */function l(e,t,a,o){return new(a||(a=Promise))((function(n,i){function r(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(r,s)}c((o=o.apply(e,t||[])).next())}))}function m(e,t){return o(e.attrs.find((e=>e.name===t)),"value")}function h(e,t,a){for(const o of e.attrs)if(o.name===t)return void(o.value=a);e.attrs.push({name:t,value:a})}function u(e,t){for(let a=0;a<e.parentNode.childNodes.length;a++)e.parentNode.childNodes[a]===e&&(e.parentNode.childNodes[a]=t);return t.childNodes.push(e),t}const v={name:"height",value:"1280"},p={name:"width",value:"1920"},f={name:"layout",value:"responsive"};function g(e,t){return t.wrap("img_size:"+e,(()=>function(e){return new Promise(((t,a)=>{let o;const n=c(e);if("http:"===n.protocol)o=i.get;else{if("https:"!==n.protocol)return a(new Error("Unsupported scheme"));o=r.get}const d=o(n,(e=>{let o,n=Buffer.alloc(0);if(200!==e.statusCode)return d.abort(),void a(Error("Cannot fetch image"));const i=e.headers["content-type"];if(!i||!i.startsWith("image/"))return d.abort(),void a(Error("File is not image"));e.on("data",(e=>{n=Buffer.concat([n,e]);try{const e=s(n);e&&(d.abort(),t(e))}catch(e){o=e}})),e.on("end",(()=>{a(o)}))}));d.on("error",(e=>{a(e)}))}))}(e)))}function w(e,t){return l(this,void 0,void 0,(function*(){if(!1===(yield t(e)))return!1;{const a=e;if(a.childNodes)for(const e of a.childNodes)if(!1===(yield w(e,t)))return!1}}))}const N=e=>{e.nodeName="div",e.tagName="div",e.attrs.length=0,e.childNodes.length=0};function y(e,t){return l(this,void 0,void 0,(function*(){const o=a.parse(e.trim());return yield w(o,(e=>l(this,void 0,void 0,(function*(){var o,i;const r=e;switch(r.nodeName){case"img":yield function(e,t){var o,i,r,s,c;return l(this,void 0,void 0,(function*(){let d;const l=null!==(o=m(e,"src"))&&void 0!==o?o:"";try{d=yield g(l,t)}catch(e){console.warn("Failed to get image size: "+l,e),d={width:1920,height:1280}}e.nodeName="amp-img",e.tagName="amp-img",e.attrs=n(e.attrs,(e=>"width"!==e.name)),e.attrs=n(e.attrs,(e=>"height"!==e.name)),e.attrs=[...e.attrs,f,{name:"width",value:null!==(r=null===(i=d.width)||void 0===i?void 0:i.toString())&&void 0!==r?r:"1920"},{name:"height",value:null!==(c=null===(s=d.height)||void 0===s?void 0:s.toString())&&void 0!==c?c:"1280"}];const v=a.parseFragment("<div />").childNodes[0];h(v,"style","width: 100vw; margin: 0 calc(50% - 50vw);"),u(e,v)}))}(r,t);break;case"blockquote":switch(m(r,"class")){case"instagram-media":yield function(e){const t=/https:\/\/www.instagram\.com\/p\/([A-Za-z0-9]+)\//;return w(e,(a=>{var o;const n=a;switch(n.nodeName){case"a":if(0===(null===(o=m(n,"href"))||void 0===o?void 0:o.search("https://www.instagram.com/"))){const a=m(n,"href"),o=t.exec(a);if(!o)return;e.nodeName="amp-instagram",e.tagName="amp-instagram",e.attrs=[f,p,v,{name:"data-shortcode",value:o[1]},{name:"data-captioned",value:""}],e.childNodes.splice(0,e.childNodes.length)}}}))}(r);break;case"twitter-tweet":yield function(e){const t=/https:\/\/twitter\.com\/.+\/status[es]*\/([0-9]+).*/;return w(e,(a=>{var o,n;const i=a;switch(i.nodeName){case"a":if(0===(null===(o=m(i,"href"))||void 0===o?void 0:o.search("https://twitter.com/"))){const a=null!==(n=m(i,"href"))&&void 0!==n?n:"",o=t.exec(a);if(!o)return;e.nodeName="amp-twitter",e.tagName="amp-twitter",e.attrs=[f,p,v,{name:"data-tweetid",value:o[1]}],e.childNodes.splice(0,e.childNodes.length)}}}))}(r)}break;case"iframe":m(r,"src")?-1!==(null===(o=m(r,"src"))||void 0===o?void 0:o.search(/youtube/))?function(e){var t,o,n;const i=null!==(t=m(e,"src"))&&void 0!==t?t:"",r=null!==(o=m(e,"width"))&&void 0!==o?o:"1920",s=null!==(n=m(e,"height"))&&void 0!==n?n:"1280",c=/youtube\.com\/embed\/([^?]+)/.exec(i);if(!c)return;e.nodeName="amp-youtube",e.tagName="amp-youtube",e.childNodes=[],e.attrs=[f,{name:"width",value:r},{name:"height",value:s},{name:"data-videoid",value:c[1]},{name:"style",value:"margin-top: 16px; margin-bottom: 16px;"}];const d=a.parseFragment("<div />").childNodes[0];h(d,"style","width: 100vw; margin: 0 calc(50% - 50vw);"),u(e,d)}(r):-1!==(null===(i=m(r,"src"))||void 0===i?void 0:i.search(/facebook/))?function(e){var t,o,n;const i=null!==(t=m(e,"width"))&&void 0!==t?t:"1920",r=null!==(o=m(e,"height"))&&void 0!==o?o:"1280",s=decodeURIComponent(null!==(n=m(e,"src"))&&void 0!==n?n:""),c=/https:\/\/www\.facebook\.com\/plugins\/(.+)\.php\?href=(.+)/.exec(s);if(!c)return;e.nodeName="amp-facebook",e.tagName="amp-facebook",e.childNodes=[],e.attrs=[f,{name:"width",value:i},{name:"height",value:r},{name:"data-embed-as",value:c[1]},{name:"data-href",value:c[2]}];const d=a.parseFragment("<div />").childNodes[0];h(d,"style",`max-width: ${i}px; margin: auto;`),u(e,d)}(r):function(e){var t,o,n;const i=null!==(t=m(e,"width"))&&void 0!==t?t:"1920",r=null!==(o=m(e,"height"))&&void 0!==o?o:"1280";let s=null!==(n=m(e,"src"))&&void 0!==n?n:"";s.startsWith("//")&&(s="https:"+s),s.startsWith("http://")&&(s=s.replace("http://","https://")),e.nodeName="amp-iframe",e.tagName="amp-iframe";const c={nodeName:"amp-img",tagName:"amp-img",attrs:[f,{name:"alt",value:"loading"},{name:"placeholder",value:""},{name:"src",value:"/assets/loading.gif"},{name:"width",value:"100"},{name:"height",value:"100"}],namespaceURI:"http://www.w3.org/1999/xhtml",parentNode:e,childNodes:[]};e.childNodes.push(c),e.attrs=[f,{name:"width",value:i},{name:"height",value:r},{name:"src",value:s},{name:"sandbox",value:"allow-scripts allow-same-origin"}];const d=a.parseFragment("<div />").childNodes[0];h(d,"style","width: 100%; margin: auto;"),u(e,d)}(r):N(r);break;case"font":"font"===r.nodeName&&function(e){var t;e.nodeName="span",e.tagName="span",e.attrs=[{name:"style",value:"color: "+(null!==(t=m(e,"color"))&&void 0!==t?t:"#333333")}]}(r);break;case"object":N(r)}})))),a.serialize(o.childNodes[0].childNodes[1])}))}export default class{constructor(a,o,n){let i={store:"memory",ttl:null!=n?n:30};o&&(i=d(i,o)),"redis"===a&&(i=d(i,{store:t})),this.cacheDriver=e.caching(i)}amplify(e){return l(this,void 0,void 0,(function*(){return y(e,this.cacheDriver)}))}}
//# sourceMappingURL=index.js.map
